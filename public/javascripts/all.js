!function(){"use strict";function e(e){console.log("client sending message ",e),I.emit("message",e)}function o(o){console.log("Adding local stream"),U.src=window.URL.createObjectURL(o),C=o,e("got user media"),b&&t()}function n(e){console.log("getUserMedia error: ",e)}function t(){!j&&"undefined"!=typeof C&&R&&(r(),T.addStream(C),j=!0,console.log("isInitator",b),b&&c())}function r(){try{T=new RTCPeerConnection(null),T.onicecandidate=i,T.onaddstream=a,T.onremovestream=u,console.log("Created RTCPeerConnection")}catch(e){return console.log("Failed to create PeerConnection , exception: "+e.message),void alert("Cannot create RTCPeerConnection object")}}function i(o){console.log("handleIceCandidate event: ",o),o.candidate?e({type:"candidate",label:o.candidate.sdpMLineIndex,id:o.candidate.sdpMid,candidate:o.candidate.candidate}):console.log("End of candidates")}function a(e){console.log("Remote stream added."),M.src=window.URL.createObjectURL(e.stream),w=e.stream}function s(){console.log("createOffer() error: ",error)}function c(){console.log("sending offer to peer"),T.createOffer(d,s)}function l(){console.log("answering offer to peer"),T.createOffer(d,null,L)}function d(o){o.sdp=m(o.sdp),T.setLocalDescription(o),console.log("setLocalAndSendMessage sending message ",o),e(o)}function f(e){var o=!1;for(var n in S.iceServers)if("turn:"===S.iceServers[n].url.substr(0,5)){o=!0,y=!0;break}if(!o){console.log("Getting TURN server from ",e);var t=new XMLHTTPRequest;t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var e=JSON.parse(t.responseText);console.log("Got TURN server ",e),S.iceServers.push({url:"turn:"+e.username+"@"+e.turn,credential:e.password}),y=!0}},t.open("GET",e,!0),t.send()}}function u(e){console.log("Remote stream removed. Event:",e)}function g(){}function m(e){for(var o,n=e.split("\r\n"),t=0;t<n.length;t++)if(n[t].search(!0)){o=t;break}if(null===o)return e;for(var r=0;r<n.length;r++)if(-1!==n[r].search("opus/48000")){var i=p(n[r],/:(d+) opus\/48000/i);i&&(n[o]=v(n[o],i));break}return n=h(n,o),e=n.join("\r\n")}function p(e,o){var n=e.match(o);return n&&2===n.length?n[1]:null}function v(e,o){for(var n=e.split(" "),t=[],r=0,i=0;i<n.length;i++)3===r&&(t[r++]=o),n[i]!==o&&(t[r++]=n[i]);return t.join(" ")}function h(e,o){for(var n=e[o].split(" "),t=e.length-1;t>=0;t--){var r=p(e[t],/a=rtpmap:(\d+) CN\/d+/i);if(r){var i=n.indexOf(r);-1!==i&&n.splice(i,1),e.splice(t,1)}}return e[o]=n.join(" "),e}var R,C,T,w,y,b=!1,j=!1,S={iceServers:[{url:"stun:stun.l.google.com:19302"}]},L={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},O=location.pathname.substring(1);""===O&&(O="foo");var I=io.connect();""!==O&&(console.log("Create or join room",O),I.emit("create or join",O)),I.on("created",function(e){console.log("Created room"+e),b=!0}),I.on("full",function(e){console.log("Room "+e+"is full")}),I.on("join",function(e){console.log("Another peer made request to join room "+e),console.log("This peer is the initator of room "+e+"!"),R=!0}),I.on("joined",function(e){console.log("This peer has joined room "+e),R=!0}),I.on("log",function(e){console.log.apply(console,e)}),I.on("message",function(e){if(console.log("Client recieved message: ",e),"got user media"===e)t();else if("offer"===e.type)b||j||t(),T.setRemoteDescription(new RTCSessionDescription(e)),l();else if("answer"===e.type)T.setRemoteDescription(new RTCSessionDescription(e));else if("candidate"===e.type&&j){var o=new RTCIceCandidate({sdpLineIndex:e.label,candidate:e.candidate});T.addIceCandidate(o)}else"bye"===e&&j&&g()});var U=document.getElementById("localVideo"),M=document.getElementById("remoteVideo"),x={video:!0};getUserMedia(x,o,n),console.log("Getting user media with constraints",x),"localhost"!=location.hostname&&f("https://computeengineondemand.appspot.com/turn?username=41784574&key=4080218913"),window.onbeforeunload=function(){e("bye")}}();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQ0FBQSxXQUNBLFlBc0xBLFNBQUEsR0FBQSxHQUNBLFFBQUEsSUFBQSwwQkFBQSxHQUVBLEVBQUEsS0FBQSxVQUFBLEdBNkJBLFFBQUEsR0FBQSxHQUNBLFFBQUEsSUFBQSx1QkFDQSxFQUFBLElBQUEsT0FBQSxJQUFBLGdCQUFBLEdBQ0EsRUFBQSxFQUNBLEVBQUEsa0JBQ0EsR0FDQSxJQUlBLFFBQUEsR0FBQSxHQUNBLFFBQUEsSUFBQSx1QkFBQSxHQWFBLFFBQUEsTUFDQSxHQUFBLG1CQUFBLElBQUEsSUFDQSxJQUNBLEVBQUEsVUFBQSxHQUNBLEdBQUEsRUFFQSxRQUFBLElBQUEsYUFBQSxHQUNBLEdBQ0EsS0FTQSxRQUFBLEtBQ0EsSUFDQSxFQUFBLEdBQUEsbUJBQUEsTUFDQSxFQUFBLGVBQUEsRUFDQSxFQUFBLFlBQUEsRUFDQSxFQUFBLGVBQUEsRUFDQSxRQUFBLElBQUEsNkJBQ0EsTUFBQSxHQUdBLE1BRkEsU0FBQSxJQUFBLGdEQUFBLEVBQUEsYUFDQSxPQUFBLDJDQUtBLFFBQUEsR0FBQSxHQUNBLFFBQUEsSUFBQSw2QkFBQSxHQUVBLEVBQUEsVUFDQSxHQUFBLEtBQUEsWUFDQSxNQUFBLEVBQUEsVUFBQSxjQUNBLEdBQUEsRUFBQSxVQUFBLE9BQ0EsVUFBQSxFQUFBLFVBQUEsWUFHQSxRQUFBLElBQUEscUJBSUEsUUFBQSxHQUFBLEdBQ0EsUUFBQSxJQUFBLHdCQUNBLEVBQUEsSUFBQSxPQUFBLElBQUEsZ0JBQUEsRUFBQSxRQUNBLEVBQUEsRUFBQSxPQUdBLFFBQUEsS0FDQSxRQUFBLElBQUEsd0JBQUEsT0FHQSxRQUFBLEtBQ0EsUUFBQSxJQUFBLHlCQUNBLEVBQUEsWUFBQSxFQUFBLEdBR0EsUUFBQSxLQUNBLFFBQUEsSUFBQSwyQkFDQSxFQUFBLFlBQUEsRUFBQSxLQUFBLEdBR0EsUUFBQSxHQUFBLEdBQ0EsRUFBQSxJQUFBLEVBQUEsRUFBQSxLQUNBLEVBQUEsb0JBQUEsR0FDQSxRQUFBLElBQUEsMENBQUEsR0FDQSxFQUFBLEdBR0EsUUFBQSxHQUFBLEdBQ0EsR0FBQSxJQUFBLENBRUEsS0FBQSxHQUFBLEtBQUEsR0FBQSxXQUNBLEdBQUEsVUFBQSxFQUFBLFdBQUEsR0FBQSxJQUFBLE9BQUEsRUFBQSxHQUFBLENBQ0EsR0FBQSxFQUNBLEdBQUEsQ0FDQSxPQUlBLElBQUEsRUFBQSxDQUNBLFFBQUEsSUFBQSw0QkFBQSxFQUVBLElBQUEsR0FBQSxHQUFBLGVBQ0EsR0FBQSxtQkFBQSxXQUNBLEdBQUEsSUFBQSxFQUFBLFlBQUEsTUFBQSxFQUFBLE9BQUEsQ0FDQSxHQUFBLEdBQUEsS0FBQSxNQUFBLEVBQUEsYUFDQSxTQUFBLElBQUEsbUJBQUEsR0FDQSxFQUFBLFdBQUEsTUFBQSxJQUFBLFFBQUEsRUFBQSxTQUFBLElBQUEsRUFBQSxLQUNBLFdBQUEsRUFBQSxXQUNBLEdBQUEsSUFHQSxFQUFBLEtBQUEsTUFBQSxHQUFBLEdBQ0EsRUFBQSxRQUlBLFFBQUEsR0FBQSxHQUNBLFFBQUEsSUFBQSxnQ0FBQSxHQVNBLFFBQUEsTUFVQSxRQUFBLEdBQUEsR0FHQSxJQUFBLEdBREEsR0FEQSxFQUFBLEVBQUEsTUFBQSxRQUVBLEVBQUEsRUFBQSxFQUFBLEVBQUEsT0FBQSxJQUNBLEdBQUEsRUFBQSxHQUFBLFFBQUEsR0FBQSxDQUNBLEVBQUEsQ0FDQSxPQUdBLEdBQUEsT0FBQSxFQUNBLE1BQUEsRUFHQSxLQUFBLEdBQUEsR0FBQSxFQUFBLEVBQUEsRUFBQSxPQUFBLElBQ0EsR0FBQSxLQUFBLEVBQUEsR0FBQSxPQUFBLGNBQUEsQ0FDQSxHQUFBLEdBQUEsRUFBQSxFQUFBLEdBQUEscUJBQ0EsS0FDQSxFQUFBLEdBQUEsRUFBQSxFQUFBLEdBQUEsR0FFQSxPQU9BLE1BSEEsR0FBQSxFQUFBLEVBQUEsR0FFQSxFQUFBLEVBQUEsS0FBQSxRQUlBLFFBQUEsR0FBQSxFQUFBLEdBQ0EsR0FBQSxHQUFBLEVBQUEsTUFBQSxFQUNBLE9BQUEsSUFBQSxJQUFBLEVBQUEsT0FBQSxFQUFBLEdBQUEsS0FHQSxRQUFBLEdBQUEsRUFBQSxHQUtBLElBQUEsR0FKQSxHQUFBLEVBQUEsTUFBQSxLQUNBLEtBQ0EsRUFBQSxFQUVBLEVBQUEsRUFBQSxFQUFBLEVBQUEsT0FBQSxJQUNBLElBQUEsSUFDQSxFQUFBLEtBQUEsR0FFQSxFQUFBLEtBQUEsSUFDQSxFQUFBLEtBQUEsRUFBQSxHQUdBLE9BQUEsR0FBQSxLQUFBLEtBR0EsUUFBQSxHQUFBLEVBQUEsR0FHQSxJQUFBLEdBRkEsR0FBQSxFQUFBLEdBQUEsTUFBQSxLQUVBLEVBQUEsRUFBQSxPQUFBLEVBQUEsR0FBQSxFQUFBLElBQUEsQ0FDQSxHQUFBLEdBQUEsRUFBQSxFQUFBLEdBQUEseUJBQ0EsSUFBQSxFQUFBLENBQ0EsR0FBQSxHQUFBLEVBQUEsUUFBQSxFQUNBLE1BQUEsR0FDQSxFQUFBLE9BQUEsRUFBQSxHQUVBLEVBQUEsT0FBQSxFQUFBLElBS0EsTUFEQSxHQUFBLEdBQUEsRUFBQSxLQUFBLEtBQ0EsRUF4U0EsR0FBQSxHQUdBLEVBQ0EsRUFDQSxFQUNBLEVBTEEsR0FBQSxFQUNBLEdBQUEsRUFNQSxHQUFBLGFBQUEsSUFBQSxrQ0FFQSxHQUFBLFdBQUEscUJBQUEsRUFDQSxxQkFBQSxJQUlBLEVBQUEsU0FBQSxTQUFBLFVBQUEsRUFDQSxNQUFBLElBQ0EsRUFBQSxNQU1BLElBQUEsR0FBQSxHQUFBLFNBRUEsTUFBQSxJQUNBLFFBQUEsSUFBQSxzQkFBQSxHQUNBLEVBQUEsS0FBQSxpQkFBQSxJQUdBLEVBQUEsR0FBQSxVQUFBLFNBQUEsR0FDQSxRQUFBLElBQUEsZUFBQSxHQUNBLEdBQUEsSUFHQSxFQUFBLEdBQUEsT0FBQSxTQUFBLEdBQ0EsUUFBQSxJQUFBLFFBQUEsRUFBQSxhQUdBLEVBQUEsR0FBQSxPQUFBLFNBQUEsR0FDQSxRQUFBLElBQUEsMENBQUEsR0FDQSxRQUFBLElBQUEscUNBQUEsRUFBQSxLQUNBLEdBQUEsSUFHQSxFQUFBLEdBQUEsU0FBQSxTQUFBLEdBQ0EsUUFBQSxJQUFBLDZCQUFBLEdBQ0EsR0FBQSxJQUdBLEVBQUEsR0FBQSxNQUFBLFNBQUEsR0FDQSxRQUFBLElBQUEsTUFBQSxRQUFBLEtBU0EsRUFBQSxHQUFBLFVBQUEsU0FBQSxHQUdBLEdBRkEsUUFBQSxJQUFBLDRCQUFBLEdBRUEsbUJBQUEsRUFDQSxRQUNBLElBQUEsVUFBQSxFQUFBLEtBQ0EsR0FBQSxHQUNBLElBRUEsRUFBQSxxQkFBQSxHQUFBLHVCQUFBLElBQ0EsUUFDQSxJQUFBLFdBQUEsRUFBQSxLQUNBLEVBQUEscUJBQUEsR0FBQSx1QkFBQSxRQUNBLElBQUEsY0FBQSxFQUFBLE1BQUEsRUFBQSxDQUNBLEdBQUEsR0FBQSxHQUFBLGtCQUFBLGFBQUEsRUFBQSxNQUNBLFVBQUEsRUFBQSxXQUVBLEdBQUEsZ0JBQUEsT0FDQSxRQUFBLEdBQUEsR0FDQSxLQUlBLElBQUEsR0FBQSxTQUFBLGVBQUEsY0FDQSxFQUFBLFNBQUEsZUFBQSxlQWdCQSxHQUFBLE9BQUEsRUFFQSxjQUFBLEVBQUEsRUFBQSxHQUVBLFFBQUEsSUFBQSxzQ0FBQSxHQUVBLGFBQUEsU0FBQSxVQUNBLEVBQUEsbUZBZ0JBLE9BQUEsZUFBQSxXQUNBLEVBQUEiLCJmaWxlIjoiYWxsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uICgpIHtcclxuICAndXNlIHN0cmljdCc7XHJcbiAgLy8gdmFyIGxvY2FsU3RyZWFtXHJcbiAgLy8gICAsIGxvY2FsUGVlckNvbm5lY3Rpb25cclxuICAvLyAgICwgcmVtb3RlUGVlckNvbm5lY3Rpb25cclxuXHJcbiAgLy8gdmFyIGxvY2FsVmlkZW8gID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvY2FsVmlkZW8nKVxyXG4gIC8vICAgLCByZW1vdGVWaWRlbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZW1vdGVWaWRlbycpXHJcbiAgLy8gICAsIHN0YXJ0QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXJ0QnV0dG9uJylcclxuICAvLyAgICwgY2FsbEJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjYWxsQnV0dG9uJylcclxuICAvLyAgICwgaGFuZ0J1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoYW5nQnV0dG9uJylcclxuXHJcbiAgLy8gc3RhcnRCdXR0b24uZGlzYWJsZWQgPSBmYWxzZVxyXG4gIC8vIGNhbGxCdXR0b24uZGlzYWJsZWQgPSB0cnVlXHJcbiAgLy8gaGFuZ0J1dHRvbi5kaXNhYmxlZCA9IGZhbHNlXHJcbiAgLy8gc3RhcnRCdXR0b24ub25jbGljayA9IHN0YXJ0XHJcbiAgLy8gY2FsbEJ1dHRvbi5vbmNsaWNrID0gY2FsbFxyXG4gIC8vIGhhbmdCdXR0b24ub25jbGljayA9IGhhbmd1cFxyXG5cclxuXHJcbiAgLy8gZnVuY3Rpb24gZ290U3RyZWFtKHN0cmVhbSkge1xyXG4gIC8vICAgdHJhY2UoXCJSZWNlaXZlZCBsb2NhbCBzdHJlYW1cIilcclxuICAvLyAgIGxvY2FsVmlkZW8uc3JjID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoc3RyZWFtKVxyXG4gIC8vICAgbG9jYWxTdHJlYW0gPSBzdHJlYW1cclxuICAvLyAgIGNhbGxCdXR0b24uZGlzYWJsZWQgPSBmYWxzZVxyXG4gIC8vIH1cclxuXHJcbiAgLy8gZnVuY3Rpb24gc3RhcnQgKCkge1xyXG4gIC8vICAgdHJhY2UoXCJSZXF1ZXN0aW5nIGxvY2FsIHN0cmVhbVwiKVxyXG4gIC8vICAgc3RhcnRCdXR0b24uZGlzYWJsZWQgPSB0cnVlXHJcbiAgLy8gICBnZXRVc2VyTWVkaWEoe3ZpZGVvOnRydWV9LCBnb3RzdHJlYW0sIGZ1bmN0aW9uIChlcnJvcikge1xyXG4gIC8vICAgICB0cmFjZShcImdldHVzZXJNZWRpYSBFcnJvcjogXCIrZXJyb3IpXHJcbiAgLy8gICB9KVxyXG4gIC8vIH1cclxuXHJcbiAgLy8gZnVuY3Rpb24gY2FsbCAoKSB7XHJcbiAgLy8gICBjYWxsQnV0dG9uLmRpc2FibGVkID0gdHJ1ZVxyXG4gIC8vICAgaGFuZ0J1dHRvbi5kaXNhYmxlZCA9IGZhbHNlXHJcbiAgLy8gICB0cmFjZShcInN0YXJ0aW5nIGNhbGxcIilcclxuXHJcbiAgLy8gICBpZiAobG9jYWxTdHJlYW0uZ2V0VmlkZW9UcmFja3MoKS5sZW5ndGggPiAwKSB7XHJcbiAgLy8gICAgIHRyYWNlKFwiVXNpbmcgdmlkZW8gZGV2aWNlIFwiK2xvY2FsU3RyZWFtLmdldFZpZGVvVHJhY2tzKClbMF0ubGFiZWwpXHJcbiAgLy8gICB9XHJcblxyXG4gIC8vICAgdmFyIHNlcnZlcnMgPSBudWxsXHJcblxyXG4gIC8vICAgbG9jYWxQZWVyQ29ubmVjdGlvbiA9IG5ldyBSVENQZWVyQ29ubmVjdGlvbihzZXJ2ZXJzKVxyXG4gIC8vICAgdHJhY2UoXCJDcmVhdGVkIGxvY2FsIHBlZXIgY29ubmVjdGlvbiBvYmplY3QgbG9jYWxQZWVyQ29ubmVjdGlvblwiKVxyXG4gIC8vICAgbG9jYWxQZWVyQ29ubmVjdGlvbi5vbmljZWNhbmRpZGF0ZSA9IGdldExvY2FsSWNlQ2FuZGlkYXRlXHJcbiAgICBcclxuICAvLyAgIHJlbW90ZVBlZXJDb25uZWN0aW9uID0gbmV3IFJUQ1BlZXJDb25uZWN0aW9uKHNlcnZlcnMpXHJcbiAgLy8gICB0cmFjZShcIkNyZWF0ZWQgbG9jYWwgcGVlciBjb25uZWN0aW9uIG9iamVjdCByZW1vdGVQZWVyQ29ubmVjdGlvblwiKVxyXG4gIC8vICAgcmVtb3RlUGVlckNvbm5lY3Rpb24ub25pY2VjYW5kaWRhdGUgPSBnZXRSZW1vdGVJY2VDYW5kaWRhdGVcclxuICAvLyAgIHJlbW90ZVBlZXJDb25uZWN0aW9uLm9uYWRkc3RyZWFtID0gZ290UmVtb3RlU3RyZWFtXHJcblxyXG4gIC8vICAgbG9jYWxQZWVyQ29ubmVjdGlvbi5hZGRTdHJlYW0obG9jYWxTdHJlYW0pXHJcbiAgLy8gICB0cmFjZShcIkFkZGVkIGxvY2FsU3RyZWFtIHRvIGxvY2FsUGVlckNvbm5lY3Rpb25cIilcclxuICAvLyAgIGxvY2FsUGVlckNvbm5lY3Rpb24uY3JlYXRlT2ZmZXIoZ290TG9jYWxEZXNjcmlwdGlvbiwgaGFuZGxlRXJyb3IpXHJcbiAgLy8gfVxyXG5cclxuICAvLyBmdW5jdGlvbiBnb3RMb2NhbERlc2NyaXB0aW9uIChkZXNjcmlwdGlvbikge1xyXG4gIC8vICAgbG9jYWxQZWVyQ29ubmVjdGlvbi5zZXRMb2NhbERlc2NyaXB0aW9uKGRlc2NyaXB0aW9uKVxyXG4gIC8vICAgdHJhY2UoXCJPZmZlciBmcm9tIGxvY2FsUGVlckNvbm5lY3Rpb246IFxcblwiKyBkZXNjcmlwdGlvbi5zZHApXHJcbiAgLy8gICByZW1vdGVQZWVyQ29ubmVjdGlvbi5zZXRSZW1vdGVEZXNjcmlwdGlvbihkZXNjcmlwdGlvbilcclxuICAvLyAgIHJlbW90ZVBlZXJDb25uZWN0aW9uLmNyZWF0ZUFuc3dlcihnb3RSZW1vdGVEZXNjcmlwdGlvbiwgaGFuZGxlRXJyb3IpXHJcbiAgLy8gfVxyXG5cclxuICAvLyBmdW5jdGlvbiBnb3RSZW1vdGVEZXNjcmlwdGlvbiAoZGVzY3JpcHRpb24pIHtcclxuICAvLyAgIHJlbW90ZVBlZXJDb25uZWN0aW9uLnNldExvY2FsRGVzY3JpcHRpb24oZGVzY3JpcHRpb24pXHJcbiAgLy8gICB0cmFjZShcIk9mZmVyIGZyb20gcmVtb3RlUGVlckNvbm5lY3Rpb246IFxcblwiKyBkZXNjcmlwdGlvbi5zZHApXHJcbiAgLy8gICBsb2NhbFBlZXJDb25uZWN0aW9uLnNldFJlbW90ZURlc2NyaXB0aW9uKGRlc2NyaXB0aW9uKVxyXG4gIC8vIH1cclxuXHJcbiAgLy8gZnVuY3Rpb24gaGFuZ3VwICgpIHtcclxuICAvLyAgIHRyYWNlKFwiRW5kaW5nIGNhbGxcIilcclxuICAvLyAgIGxvY2FsUGVlckNvbm5lY3Rpb24uY2xvc2UoKVxyXG4gIC8vICAgcmVtb3RlUGVlckNvbm5lY3Rpb24uY2xvc2UoKVxyXG4gIC8vICAgbG9jYWxQZWVyQ29ubmVjdGlvbiA9IG51bGxcclxuICAvLyAgIHJlbW90ZVBlZXJDb25uZWN0aW9uID0gbnVsbFxyXG4gIC8vICAgaGFuZ0J1dHRvbi5kaXNhYmxlZCA9IHRydWVcclxuICAvLyAgIGNhbGxCdXR0b24uZGlzYWJsZWQgPSBmYWxzZVxyXG4gIC8vIH1cclxuXHJcbiAgLy8gZnVuY3Rpb24gZ290UmVtb3RlU3RyZWFtIChldmVudCkge1xyXG4gIC8vICAgcmVtb3RlVmlkZW8uc3JjID0gd2luZG93LlVSTC5jcmVhdGVPYmplY3RVUkwoZXZlbnQuc3RyZWFtKVxyXG4gIC8vICAgdHJhY2UoXCJSZWNlaXZlZCByZW1vdGUgc3RyZWFtXCIpXHJcbiAgLy8gfVxyXG5cclxuICAvLyBmdW5jdGlvbiBnb3RMb2NhbEljZUNhbmRpZGF0ZSAoZXZlbnQpIHtcclxuICAvLyAgIGlmIChldmVudC5jYW5kaWRhdGUpIHtcclxuICAvLyAgICAgcmVtb3RlUGVlckNvbm5lY3Rpb24uUlRDSWNlQ2FuZGlkYXRlKGV2ZW50LmNhbmRpZGF0ZSlcclxuICAvLyAgICAgdHJhY2UoXCJnb3QgcmVtb3RlIElDRSBjYW5kaWRhdGU6IFxcblwiKyBldmVudC5jYW5kaWRhdGUuY2FuZGlkYXRlKVxyXG4gIC8vICAgfVxyXG4gIC8vIH1cclxuXHJcbiAgLy8gZnVuY3Rpb24gaGFuZGxlRXJyb3IgKCkge1xyXG4gICAgXHJcbiAgLy8gfVxyXG5cclxuICAvKnZhciBpc0luaXRpYXRvclxyXG4gICAgLCByb29tXHJcblxyXG4gICAgcm9vbSA9IHByb21wdCgnRW50ZXIgcm9vbSBuYW1lJylcclxuXHJcbiAgICB2YXIgc29ja2V0ID0gaW8uY29ubmVjdCgpXHJcblxyXG4gICAgaWYgKHJvb20gIT09IFwiXCIpIHtcclxuICAgICAgY29uc29sZS5sb2coJ0pvaW5pbmcgcm9vbSAnICsgcm9vbSlcclxuICAgICAgc29ja2V0LmVtaXQoJ2NyZWF0ZSBvciBqb2luJywgcm9vbSlcclxuICAgIH1cclxuXHJcbiAgICBzb2NrZXQub24oJ2Z1bGwnLCBmdW5jdGlvbiAocm9vbSkge1xyXG4gICAgICBjb25zb2xlLmxvZygnUm9vbSAnKyByb29tKyAnIGlzIGZ1bGwnKVxyXG4gICAgfSlcclxuXHJcbiAgICBzb2NrZXQub24oJ2VtcHR5JywgZnVuY3Rpb24gKHJvb20pIHtcclxuICAgICAgaXNJbml0aWF0b3IgPSB0cnVlXHJcbiAgICAgIGNvbnNvbGUubG9nKCdSb29tICcrcm9vbSsnIGlzIGVtcHR5JylcclxuICAgIH0pXHJcblxyXG4gICAgc29ja2V0Lm9uKCdqb2luJywgZnVuY3Rpb24gKHJvb20pIHtcclxuICAgICAgY29uc29sZS5sb2coJ01ha2luZyByZXF1ZXN0IHRvIGpvaW4gcm9vbSAnK3Jvb20pXHJcbiAgICAgIGNvbnNvbGUubG9nKCdJbml0YXRvcicpXHJcbiAgICB9KVxyXG5cclxuICAgIHNvY2tldC5vbignbG9nJywgZnVuY3Rpb24gKGFycmF5KSB7XHJcbiAgICAgIGNvbnNvbGUubG9nLmFwcGx5KGNvbnNvbGUsIGFycmF5KVxyXG4gICAgfSkqL1xyXG5cclxuICB2YXIgaXNDaGFubmVsUmVhZHlcclxuICAgICwgaXNJbml0YXRvciA9IGZhbHNlXHJcbiAgICAsIGlzU3RhcnRlZCAgPSBmYWxzZVxyXG4gICAgLCBsb2NhbFN0cmVhbVxyXG4gICAgLCBwY1xyXG4gICAgLCByZW1vdGVTdHJlYW1cclxuICAgICwgdHVyblJlYWR5XHJcblxyXG4gIHZhciBwY0NvbmZpZyA9IHsnaWNlU2VydmVycycgOiBbeyd1cmwnOiAnc3R1bjpzdHVuLmwuZ29vZ2xlLmNvbToxOTMwMid9XX1cclxuICAgICwgcGNDb25zdHJhaW50cyA9IHsnb3B0aW9uYWwnIDogW3snU3Rsc1NydHBLZXlBZ3JlZW1lbnQnIDogdHJ1ZX1dfVxyXG4gICAgLCBzZHBDb25zdHJhaW50cyA9IHsnbWFuZGF0b3J5JzogeyAnT2ZmZXJUb1JlY2VpdmVBdWRpbycgOiB0cnVlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICdPZmZlclRvUmVjZWl2ZVZpZGVvJyA6IHRydWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gIHZhciByb29tID0gbG9jYXRpb24ucGF0aG5hbWUuc3Vic3RyaW5nKDEpXHJcbiAgaWYgKHJvb20gPT09ICcnKSB7XHJcbiAgICByb29tID0gJ2ZvbydcclxuICB9XHJcbiAgZWxzZSB7XHJcblxyXG4gIH1cclxuXHJcbiAgdmFyIHNvY2tldCA9IGlvLmNvbm5lY3QoKVxyXG5cclxuICBpZiAocm9vbSAhPT0gJycpIHtcclxuICAgIGNvbnNvbGUubG9nKCdDcmVhdGUgb3Igam9pbiByb29tJywgcm9vbSlcclxuICAgIHNvY2tldC5lbWl0KCdjcmVhdGUgb3Igam9pbicsIHJvb20pXHJcbiAgfVxyXG5cclxuICBzb2NrZXQub24oJ2NyZWF0ZWQnLCBmdW5jdGlvbiAocm9vbSkge1xyXG4gICAgY29uc29sZS5sb2coJ0NyZWF0ZWQgcm9vbScgKyByb29tKVxyXG4gICAgaXNJbml0YXRvciA9IHRydWVcclxuICB9KVxyXG5cclxuICBzb2NrZXQub24oJ2Z1bGwnLCBmdW5jdGlvbiAocm9vbSkge1xyXG4gICAgY29uc29sZS5sb2coJ1Jvb20gJysgcm9vbSsgJ2lzIGZ1bGwnKVxyXG4gIH0pXHJcblxyXG4gIHNvY2tldC5vbignam9pbicsIGZ1bmN0aW9uIChyb29tKSB7XHJcbiAgICBjb25zb2xlLmxvZygnQW5vdGhlciBwZWVyIG1hZGUgcmVxdWVzdCB0byBqb2luIHJvb20gJytyb29tKVxyXG4gICAgY29uc29sZS5sb2coJ1RoaXMgcGVlciBpcyB0aGUgaW5pdGF0b3Igb2Ygcm9vbSAnK3Jvb20rJyEnKVxyXG4gICAgaXNDaGFubmVsUmVhZHkgPSB0cnVlXHJcbiAgfSlcclxuXHJcbiAgc29ja2V0Lm9uKCdqb2luZWQnLCBmdW5jdGlvbiAocm9vbSkge1xyXG4gICAgY29uc29sZS5sb2coJ1RoaXMgcGVlciBoYXMgam9pbmVkIHJvb20gJytyb29tKVxyXG4gICAgaXNDaGFubmVsUmVhZHkgPSB0cnVlXHJcbiAgfSlcclxuXHJcbiAgc29ja2V0Lm9uKCdsb2cnLCBmdW5jdGlvbiAoYXJyYXkpIHtcclxuICAgIGNvbnNvbGUubG9nLmFwcGx5KGNvbnNvbGUsIGFycmF5KVxyXG4gIH0pXHJcblxyXG4gIGZ1bmN0aW9uIHNlbmRNZXNzYWdlIChtZXNzYWdlKSB7XHJcbiAgICBjb25zb2xlLmxvZygnY2xpZW50IHNlbmRpbmcgbWVzc2FnZSAnLCBtZXNzYWdlKVxyXG5cclxuICAgIHNvY2tldC5lbWl0KCdtZXNzYWdlJywgbWVzc2FnZSlcclxuICB9XHJcblxyXG4gIHNvY2tldC5vbignbWVzc2FnZScsIGZ1bmN0aW9uIChtZXNzYWdlKSB7XHJcbiAgICBjb25zb2xlLmxvZygnQ2xpZW50IHJlY2lldmVkIG1lc3NhZ2U6ICcsIG1lc3NhZ2UpXHJcblxyXG4gICAgaWYgKG1lc3NhZ2UgPT09ICdnb3QgdXNlciBtZWRpYScpIHtcclxuICAgICAgbWF5YmVTdGFydCgpXHJcbiAgICB9IGVsc2UgaWYgKG1lc3NhZ2UudHlwZSA9PT0gJ29mZmVyJykge1xyXG4gICAgICAgIGlmICghaXNJbml0YXRvciAmJiAhaXNTdGFydGVkKSB7XHJcbiAgICAgICAgICBtYXliZVN0YXJ0KClcclxuICAgICAgICB9XHJcbiAgICAgICAgcGMuc2V0UmVtb3RlRGVzY3JpcHRpb24obmV3IFJUQ1Nlc3Npb25EZXNjcmlwdGlvbihtZXNzYWdlKSlcclxuICAgICAgICBkb0Fuc3dlcigpXHJcbiAgICB9IGVsc2UgaWYgKG1lc3NhZ2UudHlwZSA9PT0gJ2Fuc3dlcicpIHtcclxuICAgICAgICBwYy5zZXRSZW1vdGVEZXNjcmlwdGlvbihuZXcgUlRDU2Vzc2lvbkRlc2NyaXB0aW9uKG1lc3NhZ2UpKVxyXG4gICAgfSBlbHNlIGlmIChtZXNzYWdlLnR5cGUgPT09ICdjYW5kaWRhdGUnICYmIGlzU3RhcnRlZCkge1xyXG4gICAgICAgIHZhciBjYW5kaWRhdGUgPSBuZXcgUlRDSWNlQ2FuZGlkYXRlKHsgc2RwTGluZUluZGV4OiBtZXNzYWdlLmxhYmVsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLCBjYW5kaWRhdGU6IG1lc3NhZ2UuY2FuZGlkYXRlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICBwYy5hZGRJY2VDYW5kaWRhdGUoY2FuZGlkYXRlKVxyXG4gICAgfSBlbHNlIGlmIChtZXNzYWdlID09PSAnYnllJyAmJiBpc1N0YXJ0ZWQpIHtcclxuICAgICAgaGFuZGxlUmVtb3RlSGFuZ3VwKClcclxuICAgIH1cclxuICB9KVxyXG5cclxuICB2YXIgbG9jYWxWaWRlbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2NhbFZpZGVvJylcclxuICAgICwgcmVtb3RlVmlkZW8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVtb3RlVmlkZW8nKVxyXG5cclxuICBmdW5jdGlvbiBoYW5kbGVVc2VyTWVkaWEgKHN0cmVhbSkge1xyXG4gICAgY29uc29sZS5sb2coJ0FkZGluZyBsb2NhbCBzdHJlYW0nKVxyXG4gICAgbG9jYWxWaWRlby5zcmMgPSB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChzdHJlYW0pXHJcbiAgICBsb2NhbFN0cmVhbSA9IHN0cmVhbVxyXG4gICAgc2VuZE1lc3NhZ2UoJ2dvdCB1c2VyIG1lZGlhJylcclxuICAgIGlmIChpc0luaXRhdG9yKSB7XHJcbiAgICAgIG1heWJlU3RhcnQoKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gaGFuZGxlVXNlck1lZGlhRXJyb3IgKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmxvZygnZ2V0VXNlck1lZGlhIGVycm9yOiAnLCBlcnJvcilcclxuICB9XHJcblxyXG4gIHZhciBjb25zdHJhaW50cyA9IHt2aWRlbyA6IHRydWV9XHJcblxyXG4gIGdldFVzZXJNZWRpYShjb25zdHJhaW50cywgaGFuZGxlVXNlck1lZGlhLCBoYW5kbGVVc2VyTWVkaWFFcnJvcilcclxuXHJcbiAgY29uc29sZS5sb2coJ0dldHRpbmcgdXNlciBtZWRpYSB3aXRoIGNvbnN0cmFpbnRzJywgY29uc3RyYWludHMpXHJcblxyXG4gIGlmIChsb2NhdGlvbi5ob3N0bmFtZSAhPSAnbG9jYWxob3N0Jykge1xyXG4gICAgcmVxdWVzdFR1cm4oJ2h0dHBzOi8vY29tcHV0ZWVuZ2luZW9uZGVtYW5kLmFwcHNwb3QuY29tL3R1cm4/dXNlcm5hbWU9NDE3ODQ1NzQma2V5PTQwODAyMTg5MTMnKVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gbWF5YmVTdGFydCAoKSB7XHJcbiAgICBpZiAoIWlzU3RhcnRlZCAmJiB0eXBlb2YgbG9jYWxTdHJlYW0gIT0gJ3VuZGVmaW5lZCcgJiYgaXNDaGFubmVsUmVhZHkpIHtcclxuICAgICAgY3JlYXRlUGVlckNvbm5lY3Rpb24oKVxyXG4gICAgICBwYy5hZGRTdHJlYW0obG9jYWxTdHJlYW0pXHJcbiAgICAgIGlzU3RhcnRlZCA9IHRydWVcclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKCdpc0luaXRhdG9yJywgaXNJbml0YXRvcilcclxuICAgICAgaWYgKGlzSW5pdGF0b3IpIHtcclxuICAgICAgICBkb0NhbGwoKVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICB3aW5kb3cub25iZWZvcmV1bmxvYWQgPSBmdW5jdGlvbiAoZXZlbnQpIHtcclxuICAgIHNlbmRNZXNzYWdlKCdieWUnKVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gY3JlYXRlUGVlckNvbm5lY3Rpb24gKCkge1xyXG4gICAgdHJ5IHtcclxuICAgICAgcGMgPSBuZXcgUlRDUGVlckNvbm5lY3Rpb24obnVsbClcclxuICAgICAgcGMub25pY2VjYW5kaWRhdGUgPSBoYW5kbGVJY2VDYW5kaWRhdGVcclxuICAgICAgcGMub25hZGRzdHJlYW0gPSBoYW5kbGVSZW1vdGVTdHJlYW1BZGRlZFxyXG4gICAgICBwYy5vbnJlbW92ZXN0cmVhbSA9IGhhbmRsZVJlbW90ZVN0cmVhbVJlbW92ZWRcclxuICAgICAgY29uc29sZS5sb2coJ0NyZWF0ZWQgUlRDUGVlckNvbm5lY3Rpb24nKVxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIGNyZWF0ZSBQZWVyQ29ubmVjdGlvbiAsIGV4Y2VwdGlvbjogJysgZS5tZXNzYWdlKVxyXG4gICAgICBhbGVydCgnQ2Fubm90IGNyZWF0ZSBSVENQZWVyQ29ubmVjdGlvbiBvYmplY3QnKVxyXG4gICAgICByZXR1cm5cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGhhbmRsZUljZUNhbmRpZGF0ZSAoZXZlbnQpIHtcclxuICAgIGNvbnNvbGUubG9nKCdoYW5kbGVJY2VDYW5kaWRhdGUgZXZlbnQ6ICcsIGV2ZW50KVxyXG5cclxuICAgIGlmIChldmVudC5jYW5kaWRhdGUpIHtcclxuICAgICAgICBzZW5kTWVzc2FnZSh7IHR5cGUgOiAnY2FuZGlkYXRlJ1xyXG4gICAgICAgICAgICAgICAgICAsIGxhYmVsIDogZXZlbnQuY2FuZGlkYXRlLnNkcE1MaW5lSW5kZXhcclxuICAgICAgICAgICAgICAgICAgLCBpZCA6IGV2ZW50LmNhbmRpZGF0ZS5zZHBNaWRcclxuICAgICAgICAgICAgICAgICAgLCBjYW5kaWRhdGUgOiBldmVudC5jYW5kaWRhdGUuY2FuZGlkYXRlXHJcbiAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdFbmQgb2YgY2FuZGlkYXRlcycpXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBoYW5kbGVSZW1vdGVTdHJlYW1BZGRlZCAoZXZlbnQpIHtcclxuICAgIGNvbnNvbGUubG9nKCdSZW1vdGUgc3RyZWFtIGFkZGVkLicpXHJcbiAgICByZW1vdGVWaWRlby5zcmMgPSB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChldmVudC5zdHJlYW0pXHJcbiAgICByZW1vdGVTdHJlYW0gPSBldmVudC5zdHJlYW1cclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGhhbmRsZUNyZWF0ZU9mZmVyRXJyb3IgKGV2ZW50KSB7XHJcbiAgICBjb25zb2xlLmxvZygnY3JlYXRlT2ZmZXIoKSBlcnJvcjogJywgZXJyb3IpXHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBkb0NhbGwgKCkge1xyXG4gICAgY29uc29sZS5sb2coJ3NlbmRpbmcgb2ZmZXIgdG8gcGVlcicpXHJcbiAgICBwYy5jcmVhdGVPZmZlcihzZXRMb2NhbEFuZFNlbmRNZXNzYWdlLCBoYW5kbGVDcmVhdGVPZmZlckVycm9yKVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZG9BbnN3ZXIgKCkge1xyXG4gICAgY29uc29sZS5sb2coJ2Fuc3dlcmluZyBvZmZlciB0byBwZWVyJylcclxuICAgIHBjLmNyZWF0ZU9mZmVyKHNldExvY2FsQW5kU2VuZE1lc3NhZ2UsIG51bGwsIHNkcENvbnN0cmFpbnRzKVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gc2V0TG9jYWxBbmRTZW5kTWVzc2FnZSAoc2Vzc2lvbkRlc2NyaXB0aW9uKSB7XHJcbiAgICBzZXNzaW9uRGVzY3JpcHRpb24uc2RwID0gcHJlZmVyT3B1cyhzZXNzaW9uRGVzY3JpcHRpb24uc2RwKVxyXG4gICAgcGMuc2V0TG9jYWxEZXNjcmlwdGlvbihzZXNzaW9uRGVzY3JpcHRpb24pXHJcbiAgICBjb25zb2xlLmxvZygnc2V0TG9jYWxBbmRTZW5kTWVzc2FnZSBzZW5kaW5nIG1lc3NhZ2UgJywgc2Vzc2lvbkRlc2NyaXB0aW9uKVxyXG4gICAgc2VuZE1lc3NhZ2Uoc2Vzc2lvbkRlc2NyaXB0aW9uKVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gcmVxdWVzdFR1cm4gKHR1cm5VUkwpIHtcclxuICAgIHZhciB0dXJuRXhpc3RzID0gZmFsc2VcclxuXHJcbiAgICBmb3IgKHZhciBpIGluIHBjQ29uZmlnLmljZVNlcnZlcnMpIHtcclxuICAgICAgaWYgKHBjQ29uZmlnLmljZVNlcnZlcnNbaV0udXJsLnN1YnN0cigwLCA1KSA9PT0gJ3R1cm46Jykge1xyXG4gICAgICAgIHR1cm5FeGlzdHMgPSB0cnVlXHJcbiAgICAgICAgdHVyblJlYWR5ID0gdHJ1ZVxyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF0dXJuRXhpc3RzKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdHZXR0aW5nIFRVUk4gc2VydmVyIGZyb20gJywgdHVyblVSTClcclxuXHJcbiAgICAgIHZhciB4aHIgPSBuZXcgWE1MSFRUUFJlcXVlc3QoKVxyXG4gICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgaWYgKHhoci5yZWFkeVN0YXRlID09PSA0ICYmIHhoci5zdGF0dXMgPT09IDIwMCkge1xyXG4gICAgICAgICAgdmFyIHR1cm5TZXJ2ZXIgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpXHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnR290IFRVUk4gc2VydmVyICcsIHR1cm5TZXJ2ZXIpXHJcbiAgICAgICAgICBwY0NvbmZpZy5pY2VTZXJ2ZXJzLnB1c2goeyAndXJsJyA6ICd0dXJuOicrdHVyblNlcnZlci51c2VybmFtZSArICdAJyt0dXJuU2VydmVyLnR1cm5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAsICdjcmVkZW50aWFsJyA6IHR1cm5TZXJ2ZXIucGFzc3dvcmR9KVxyXG4gICAgICAgICAgdHVyblJlYWR5ID0gdHJ1ZVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICB4aHIub3BlbignR0VUJywgdHVyblVSTCwgdHJ1ZSlcclxuICAgICAgeGhyLnNlbmQoKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gaGFuZGxlUmVtb3RlU3RyZWFtUmVtb3ZlZCAoZXZlbnQpIHtcclxuICAgIGNvbnNvbGUubG9nKCdSZW1vdGUgc3RyZWFtIHJlbW92ZWQuIEV2ZW50OicsIGV2ZW50KVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gaGFuZ3VwICgpIHtcclxuICAgIGNvbnNvbGUubG9nKCdIYW5naW5nIHVwJylcclxuICAgIHN0b3AoKVxyXG4gICAgc2VuZE1lc3NhZ2UoJ2J5ZScpXHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBoYW5kbGVSZW1vdGVIYW5ndXAgKCkge1xyXG4gICAgXHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBzdG9wICgpIHtcclxuICAgIGlzU3RhcnRlZCA9IGZhbHNlXHJcbiAgICBwYy5jbG9zZSgpXHJcbiAgICBwYyA9IG51bGxcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIHByZWZlck9wdXMgKHNkcCkge1xyXG4gICAgdmFyIHNkcExpbmVzID0gc2RwLnNwbGl0KCdcXHJcXG4nKVxyXG4gICAgdmFyIG1MaW5lSW5kZXhcclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2RwTGluZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgaWYgKHNkcExpbmVzW2ldLnNlYXJjaCgnbT1hdWRpbycgIT09IC0xKSkge1xyXG4gICAgICAgIG1MaW5lSW5kZXggPSBpXHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChtTGluZUluZGV4ID09PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBzZHBcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKHZhciBzZWNvbmRJbmRleCA9IDA7IHNlY29uZEluZGV4IDwgc2RwTGluZXMubGVuZ3RoOyBzZWNvbmRJbmRleCsrKSB7XHJcbiAgICAgIGlmIChzZHBMaW5lc1tzZWNvbmRJbmRleF0uc2VhcmNoKCdvcHVzLzQ4MDAwJykgIT09IC0xKSB7XHJcbiAgICAgICAgdmFyIG9wdXNQYXlsb2FkID0gZXh0cmFjdFNkcChzZHBMaW5lc1tzZWNvbmRJbmRleF0sIC86KGQrKSBvcHVzXFwvNDgwMDAvaSlcclxuICAgICAgICBpZiAob3B1c1BheWxvYWQpIHtcclxuICAgICAgICAgIHNkcExpbmVzW21MaW5lSW5kZXhdID0gc2V0RGVmYXVsdENvZGVjKHNkcExpbmVzW21MaW5lSW5kZXhdLCBvcHVzUGF5bG9hZClcclxuICAgICAgICB9XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZHBMaW5lcyA9IHJlbW92ZUNOKHNkcExpbmVzLCBtTGluZUluZGV4KVxyXG5cclxuICAgIHNkcCA9IHNkcExpbmVzLmpvaW4oJ1xcclxcbicpXHJcbiAgICByZXR1cm4gc2RwXHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBleHRyYWN0U2RwIChzZHBMaW5lLCBwYXR0ZXJuKSB7XHJcbiAgICB2YXIgcmVzdWx0ID0gc2RwTGluZS5tYXRjaChwYXR0ZXJuKVxyXG4gICAgcmV0dXJuIHJlc3VsdCAmJiByZXN1bHQubGVuZ3RoID09PSAyID8gcmVzdWx0WzFdIDogbnVsbFxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gc2V0RGVmYXVsdENvZGVjIChtTGluZSwgcGF5bG9hZCkge1xyXG4gICAgdmFyIGVsZW1lbnRzID0gbUxpbmUuc3BsaXQoJyAnKVxyXG4gICAgICAsIG5ld0xpbmUgPSBbXVxyXG4gICAgICAsIGluZGV4ID0gMFxyXG5cclxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxlbWVudHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgaWYgKGluZGV4ID09PSAzKSB7XHJcbiAgICAgICAgbmV3TGluZVtpbmRleCsrXSA9IHBheWxvYWRcclxuICAgICAgfVxyXG4gICAgICBpZiAoZWxlbWVudHNbaV0gIT09IHBheWxvYWQpIHtcclxuICAgICAgICBuZXdMaW5lW2luZGV4KytdID0gZWxlbWVudHNbaV1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5ld0xpbmUuam9pbignICcpXHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiByZW1vdmVDTiAoc2RwTGluZXMsIG1MaW5lSW5kZXgpIHtcclxuICAgIHZhciBtTGluZXNFbGVtZW50cyA9IHNkcExpbmVzW21MaW5lSW5kZXhdLnNwbGl0KCcgJylcclxuXHJcbiAgICBmb3IgKHZhciBpID0gc2RwTGluZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcclxuICAgICAgdmFyIHBheWxvYWQgPSBleHRyYWN0U2RwKHNkcExpbmVzW2ldLCAvYT1ydHBtYXA6KFxcZCspIENOXFwvZCsvaSlcclxuICAgICAgaWYgKHBheWxvYWQpIHtcclxuICAgICAgICB2YXIgY25Qb3MgPSBtTGluZXNFbGVtZW50cy5pbmRleE9mKHBheWxvYWQpXHJcbiAgICAgICAgaWYgKGNuUG9zICE9PSAtMSkge1xyXG4gICAgICAgICAgbUxpbmVzRWxlbWVudHMuc3BsaWNlKGNuUG9zLCAxKVxyXG4gICAgICAgIH1cclxuICAgICAgICBzZHBMaW5lcy5zcGxpY2UoaSwgMSlcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNkcExpbmVzW21MaW5lSW5kZXhdID0gbUxpbmVzRWxlbWVudHMuam9pbignICcpXHJcbiAgICByZXR1cm4gc2RwTGluZXNcclxuICB9XHJcbn0pKCkiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=